<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="p-3">

<div class="container">
    <h2>Админ-панель</h2>

    <div class="d-flex justify-content-between mb-2">
        <button class="btn btn-primary" onclick="manualRefresh()">Обновить</button>
        <button class="btn btn-danger" onclick="clearCache()">Очистить кеш</button>
    </div>

    <div class="d-flex mb-3">
        <input id="newUserId" class="form-control me-2" placeholder="ID пользователя">
        <input id="newUserName" class="form-control me-2" placeholder="Имя">
        <button class="btn btn-success" onclick="setUserName()">Присвоить имя</button>
    </div>

    <div id="map" style="height:60vh;"></div>

    <table class="table table-striped table-bordered mt-3">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Имя</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>Статус</th>
                <th>Последнее обновление</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody id="userTable"></tbody>
    </table>
</div>

<script>
const map = L.map("map").setView([0,0],2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

const socket = io();
let markers = {};

function formatTime(ts){
    const d = new Date(ts*1000);
    return d.toLocaleTimeString();
}

socket.on("locations", users => {
    const table = document.getElementById("userTable");
    table.innerHTML = "";
    const now = Date.now()/1000;

    for(const id in users){
        const u = users[id];
        const lat = u.lat;
        const lon = u.lon;
        const last = u.last_update;
        const online = (now - last) < 10;
        const name = u.name || id;

        if(!markers[id]){
            markers[id] = L.marker([lat, lon]).addTo(map).bindPopup(name);
            markers[id].on('click', ()=>{
                const newName = prompt("Введите новое имя:", name);
                if(newName) renameUser(id, newName);
            });
        } else {
            markers[id].setLatLng([lat, lon]);
            markers[id].bindPopup(name);
        }

        table.innerHTML += `<tr>
            <td>${id}</td>
            <td>${name}</td>
            <td>${lat.toFixed(5)}</td>
            <td>${lon.toFixed(5)}</td>
            <td>${online ? '<span class="text-success">online</span>' : '<span class="text-danger">offline</span>'}</td>
            <td>${formatTime(last)}</td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="renameUser('${id}')">Имя</button>
                <button class="btn btn-sm btn-danger" onclick="deleteUser('${id}')">Удалить</button>
            </td>
        </tr>`;
    }
});

// --- Actions ---
function manualRefresh(){
    socket.emit("manual_refresh");
}

function clearCache(){
    fetch("/admin/clear",{method:"POST"}).then(()=>{
        alert("Кеш очищен");
        for(const id in markers){
            map.removeLayer(markers[id]);
        }
        markers = {};
        document.getElementById("userTable").innerHTML = "";
    });
}

function deleteUser(uid){
    fetch(`/admin/delete/${uid}`,{method:"POST"}).then(()=>{
        alert("Пользователь удален");
        if(markers[uid]){
            map.removeLayer(markers[uid]);
            delete markers[uid];
        }
        socket.emit("manual_refresh");
    });
}

function renameUser(uid, newName=null){
    if(!newName) newName = prompt("Введите новое имя:");
    if(!newName) return;
    fetch(`/admin/rename/${uid}`,{
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({name: newName})
    });
}

function setUserName(){
    const uid = document.getElementById("newUserId").value.trim();
    const name = document.getElementById("newUserName").value.trim();
    if(!uid || !name) return alert("Введите ID и имя");

    fetch(`/admin/setname/${uid}`,{
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({name: name})
    }).then(()=>{
        alert(`Имя "${name}" присвоено ID ${uid}`);
        document.getElementById("newUserId").value = "";
        document.getElementById("newUserName").value = "";
    });
}
</script>

</body>
</html>
