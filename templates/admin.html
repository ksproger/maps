<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Admin Dashboard</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        #map { height: 60vh; width: 100%; margin-bottom: 20px; }
        table { width: 100%; }
    </style>
</head>
<body class="p-3">

<div class="container">
    <h2 class="mb-3">Админ-панель</h2>
    <div id="map" class="mb-3"></div>

    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>Статус</th>
                <th>Последнее обновление</th>
            </tr>
        </thead>
        <tbody id="userTable"></tbody>
    </table>
</div>

<script>
const map = L.map("map").setView([0,0],2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

const socket = io();
let markers = {};

function formatTime(ts) {
    const d = new Date(ts*1000);
    return d.toLocaleTimeString();
}

socket.on("locations", (users) => {
    const table = document.getElementById("userTable");
    table.innerHTML = "";

    const now = Date.now()/1000;

    for (const id in users) {
        const u = users[id];
        const lat = u.lat;
        const lon = u.lon;
        const last = u.last_update;
        const online = (now - last) < 10;

        if (!markers[id]) {
            markers[id] = L.marker([lat, lon]).addTo(map).bindPopup(id);
        } else {
            markers[id].setLatLng([lat, lon]);
        }

        table.innerHTML += `<tr>
            <td>${id}</td>
            <td>${lat.toFixed(5)}</td>
            <td>${lon.toFixed(5)}</td>
            <td>${online ? '<span class="text-success">online</span>' : '<span class="text-danger">offline</span>'}</td>
            <td>${formatTime(last)}</td>
        </tr>`;
    }
});
</script>

</body>
</html>
